---
title: 聊聊分布式[分布式锁]
tags: [java, 分布式]
---

本篇文章

<! -- more -->

#### 为什么要使用分布式锁
考虑一种场景

#### 分布式锁
在集群环境下，对于同一条数据，在相互竞争的情况下，很容易就发生数据脏乱的情况。

简单讲分布式锁，是增强版的本地锁。多个服务竞争某个资源的时候，需要对资源加锁，以防止发生预料之外的事情。

#### 分布式锁的实现方式
有三种，一种是基于zookeeper，一种基于redis，一种基于数据库
##### 基于Redis

###### 原理
- 获取锁
redis操作指令中有一个命令为(原子性命令)
`set key value [EX secones] [PX milliseconds][NX|XX]`
表示设置为某个key设置超时时间.
* EX seconds: 超时时间
* PX milliseconds: 设定过期时间，单位为毫秒
* NX 仅当key不存在设置值
* XX 仅当key存在设置值。

- 释放锁
就是把获取到的锁，释放掉，这里注意下是要使用两个命令`get`(获取到值) 和 `del`(删除key)
所以要使用lua脚本来保证原子性操作

特别地:
value要具有唯一性,最常见的就是UUID。如果不是唯一值将会存在以下问题:
* 锁被误获取，会存在多个客户端同时获取锁成功(可重入锁)
* 锁被误释放。-> 解决办法其实就是不同的服务的value是不一样的，释放的时候双重校验

##### 基于zookeeper
- zookeeper